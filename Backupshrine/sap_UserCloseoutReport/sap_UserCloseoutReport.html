<template>
  <lightning-card>
    <div class="SE-content">
      <template if:true={isvisible}>
        <div class="alert-container">
          <div class="content-sec">
              <lightning-icon icon-name="utility:info" size="xx-small"
                  class="slds-m-right_small my-icon">
              </lightning-icon>
              <span>Online Transactions are not included in this report</span>
              <button class="dismiss-button" onclick={handleDismiss}>
                  <lightning-icon icon-name="utility:close" size="xx-small" alternative-text="Close">
                  </lightning-icon>
              </button>
          </div>
        </div>
      </template>
      <div class="SE-Card secondDivForSearching">
        <div class="slds-grid slds-grid_align-spread">
          <div class="slds-col" style="display: flex"></div>
            <div class="slds-grid slds-grid_align-end slds-m-bottom_medium">
              <div class="buttoncontainerfilter">
                <!-- Filter and Export Buttons -->
                <div class="right-buttons">
                  <!-- <lightning-badge
                    data-id="today"
                    label="Today"
                    class={badgeClassCurrentDay}
                    onclick={handleBadgeClick}
                  ></lightning-badge>
                  <lightning-badge
                    data-id="this-week"
                    label="This Week"
                    class={badgeClassThisWeek}
                    onclick={handleBadgeClick}
                  ></lightning-badge>
                  <lightning-badge
                    data-id="this-month"
                    label="This Month"
                    class={badgeClassThisMonth}
                    onclick={handleBadgeClick}
                  ></lightning-badge>
                  <lightning-badge
                    data-id="this-quarter"
                    label="This Quarter"
                    class={badgeClassThisQuarter}
                    onclick={handleBadgeClick}
                  ></lightning-badge>
                  <lightning-badge
                    data-id="this-year"
                    label="This Year"
                    class={badgeClassThisYear}
                    onclick={handleBadgeClick}
                  ></lightning-badge> -->
                  <div class="export-button" title="Export to Excel" onclick={handleExportResultButtonClick}>
                    <lightning-icon icon-name="doctype:excel" size="xx-small" alternative-text="Excel Icon"></lightning-icon>
                    <span>Export to Excel</span>
                </div>
                  <lightning-button icon-name="utility:download" variant="brand" label="Download PDF"
                                  onclick={handleDownloadPdf} class="customButton slds-m-left_small">
                              </lightning-button>
                  </div>
                </div>
              </div>
        </div>
        <div class="slds-m-around_medium">
          <template if:true={isRecordsLoading}>
            <lightning-spinner alternative-text="Loading..." size="medium"></lightning-spinner>
          </template>
    
          <template if:true={structuredData.length}>
            <template for:each={structuredData} for:item="activityData">
              <div key={activityData.activity} class="slds-m-bottom_medium SE-Card secondDivForSearching">
                <div class="slds-section slds-m-bottom_small">
                  <div class="slds-section__title slds-grid slds-align-items-center">
                    <!-- Clickable Icon for Expand/Collapse -->
                    <lightning-icon 
                      icon-name="utility:chevrondown" 
                      size="x-small" 
                      class="slds-m-right_small toggle-icon"
                      data-activity={activityData.activity} 
                      onclick={toggleSection}>
                    </lightning-icon>

                    <!-- Static Label (Not Clickable) -->
                    <span class="slds-text-title_bold text-size">{activityData.activity}</span>
                  </div>
                </div>
    
                <div class="slds-section slds-is-open" data-id={activityData.activity}>
                  <template for:each={activityData.payments} for:item="paymentData">
                    <div key={paymentData.paymentType} class="slds-m-left_medium SE-Card secondDivForSearching">
                      <span class="slds-text-title_bold text-size">{paymentData.paymentType}</span>
                      <lightning-badge label={paymentData.recordSummaryLabel}
                      class="slds-badge_inverse result-no-css"></lightning-badge>
    
                      <!-- Table Wrapper -->
                      <div class="slds-scrollable_x custom-table-wrapper data-section">
                        <table class="slds-table slds-table_cell-buffer slds-table_bordered custom-table">
                          <thead>
                            <tr class="custom-header">
                              <th scope="col">W/O Invoice #</th>
                              <th scope="col">Name</th>
                              <th scope="col">Payment Details</th>
                              <th scope="col">Amount</th>
                              <th scope="col">Date</th>
                            </tr>
                          </thead>
                          <tbody>
                            <template for:each={paymentData.transactions} for:item="transaction">
                              <tr key={transaction.WorkOrderNo}>
                                <td>
                                  <div class="slds-truncate" title={transaction.WorkOrderNo}>{transaction.WorkOrderNo}</div>
                                </td>
                                <td>
                                  <div class="slds-truncate" title={transaction.Name}>{transaction.Name}</div>
                                </td>
                                <td>
                                  <div class="slds-truncate" title={transaction.PaymentDetails}>{transaction.PaymentDetails}</div>
                                </td>
                                <td class="slds-text-align_right">
                                  <lightning-formatted-number  
                                    value={transaction.Amount}
                                    format-style="currency"
                                    currency-code="USD">
                                  </lightning-formatted-number>
                                </td>
                                <td>
                                  <div class="slds-truncate" title={transaction.Date}>{transaction.Date}</div>
                                </td>
                              </tr>
                            </template>
                          </tbody>
                          <tfoot>
                            <tr class="total-row">
                              <td colspan="3"><strong>Total</strong></td>
                              <td class="slds-text-align_right">
                                <lightning-formatted-number 
                                  value={paymentData.totalAmount} 
                                  format-style="currency" 
                                  currency-code="USD">
                                </lightning-formatted-number>
                              </td>
                              <td></td>
                            </tr>
                          </tfoot>
                        </table>
                      </div>
                    </div>
                  </template>
                </div>
              </div>
            </template>
          </template>
    
          <template if:false={structuredData.length}>
            <div class="no-result-found">
              <h1 class="no-result-found-label">No Results Found</h1>
          </div>
          </template>
        </div>

      </div>
    </div>
  </lightning-card>

  <c-sap_-finsys-export-to-excel></c-sap_-finsys-export-to-excel>
  <c-sap_-finsys-reports-pdf-generator></c-sap_-finsys-reports-pdf-generator>
    
</template>